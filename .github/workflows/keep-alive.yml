name: Keep Streamlit App Alive (Playwright)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

concurrency:
  group: keep-streamlit-alive
  cancel-in-progress: true

jobs:
  keep_alive:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    env:
      APP_URL: https://etsa-survey.streamlit.app/
      SLEEP_PAGE_TEXT: app is asleep
      MINIMUM_CONTENT_LENGTH: "1000"
      KEEP_OPEN_MS: "20000" # how long to keep session open (ms)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Playwright and deps
        run: |
          python -m pip install --upgrade pip
          pip install playwright==1.46.0
          python -m playwright install --with-deps chromium

      - name: Keep Streamlit alive with headless browser
        env:
          APP_URL: ${{ env.APP_URL }}
          SLEEP_PAGE_TEXT: ${{ env.SLEEP_PAGE_TEXT }}
          MINIMUM_CONTENT_LENGTH: ${{ env.MINIMUM_CONTENT_LENGTH }}
          KEEP_OPEN_MS: ${{ env.KEEP_OPEN_MS }}
        run: |
          python scripts/keep_streamlit_alive.py

      - name: Upload artifacts (HTML and screenshot)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: keep-alive-artifacts
          path: |
            response.html
            screenshot.png
            debug.log
          if-no-files-found: ignore
